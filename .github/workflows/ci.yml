name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'
          echo "PostgreSQL is ready!"
          
          echo "Waiting for RabbitMQ..."
          timeout 60 bash -c 'until curl -s http://localhost:15672 > /dev/null; do sleep 1; done'
          echo "RabbitMQ is ready!"

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/postgres
          RABBITMQ_URL: amqp://guest:guest@localhost/
        run: |
          python -m pytest app/test_main.py -v \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --cov-fail-under=90 \
            --asyncio-mode=auto \
            --junitxml=junit.xml \
            2>&1 | tee pytest-output.txt

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² pytest
          if [ -f pytest-output.txt ]; then
            PASSED=$(grep -oP '\d+(?= passed)' pytest-output.txt | tail -1 || echo "0")
            FAILED=$(grep -oP '\d+(?= failed)' pytest-output.txt | tail -1 || echo "0")
            SKIPPED=$(grep -oP '\d+(?= skipped)' pytest-output.txt | tail -1 || echo "0")
            WARNINGS=$(grep -oP '\d+(?= warning)' pytest-output.txt | tail -1 || echo "0")
            
            echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Warnings | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f pytest-output.txt ]; then
            # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¸Ñ‰ÐµÐ¼ "TOTAL ... XX%"
            COVERAGE=$(grep "TOTAL" pytest-output.txt | grep -oP '\d+%' | grep -oP '\d+' | tail -1 || echo "")
            
            # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: ÐµÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð¸Ñ‰ÐµÐ¼ "Total coverage: XX.XX%"
            if [ -z "$COVERAGE" ]; then
              COVERAGE=$(grep -i "total coverage" pytest-output.txt | grep -oP '\d+\.\d+|\d+' | head -1 || echo "")
            fi
            
            # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð¸Ñ‰ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð¼ Ð² ÐºÐ¾Ð½Ñ†Ðµ
            if [ -z "$COVERAGE" ]; then
              COVERAGE=$(grep "Required test coverage" pytest-output.txt | grep -oP '\d+\.\d+|\d+' | tail -1 || echo "")
            fi
            
            # ÐžÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ
            if [ -n "$COVERAGE" ]; then
              COVERAGE=$(printf "%.0f" "$COVERAGE" 2>/dev/null || echo "$COVERAGE")
            else
              COVERAGE="N/A"
            fi
            
            echo "### ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$COVERAGE" != "N/A" ]; then
              # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¸ Ñ†Ð²ÐµÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
              if [ "$COVERAGE" -ge 90 ] 2>/dev/null; then
                BADGE_COLOR="brightgreen"
                EMOJI="ðŸŸ¢"
              elif [ "$COVERAGE" -ge 80 ] 2>/dev/null; then
                BADGE_COLOR="green"
                EMOJI="ðŸŸ¡"
              elif [ "$COVERAGE" -ge 70 ] 2>/dev/null; then
                BADGE_COLOR="yellow"
                EMOJI="ðŸŸ "
              else
                BADGE_COLOR="red"
                EMOJI="ðŸ”´"
              fi
              
              echo "#### $EMOJI Total Coverage: **${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "![Coverage](https://img.shields.io/badge/coverage-${COVERAGE}%25-${BADGE_COLOR})" >> $GITHUB_STEP_SUMMARY
            else
              echo "#### âš ï¸ Coverage data not available" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
          if [ -f pytest-output.txt ]; then
            DURATION=$(grep -oP '\d+\.\d+(?=s)' pytest-output.txt | tail -1 || echo "N/A")
            echo "â±ï¸ **Test Duration:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
         

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  docker-build:
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t backend-app:test .

      - name: Test Docker image
        run: |
          docker images backend-app:test